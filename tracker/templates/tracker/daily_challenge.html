{% extends "tracker/base.html" %}
{% load tz %}

{% block content %}
<div class="container my-5">

    <!-- Flash Messages -->
    {% if messages %}
        <div class="mb-4">
            {% for message in messages %}
                <div class="alert alert-info alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Daily Challenge Card -->
    <div class="card shadow-lg mb-4">
        <div class="card-body">
            <h2 class="card-title text-primary mb-3">
                Today's Challenge â€” <span class="text-dark">{{ today }}</span>
            </h2>

            <!-- Problem Info -->
            <div class="mb-3">
                <h4 class="text-success">{{ daily_challenge.problem.title }}</h4>
                <p class="text-muted">{{ daily_challenge.problem.description }}</p>

                {% if daily_challenge.problem.url %}
                    <a href="{{ daily_challenge.problem.url }}" target="_blank" class="btn btn-outline-primary btn-sm mt-2">
                        View Full Problem
                    </a>
                {% endif %}
            </div>

            <!-- Already Solved Info -->
            {% if already_solved %}
                <p class="text-warning fw-semibold">You have already solved this problem.</p>
            {% endif %}

            <!-- Challenge Completion Logic -->
            {% if not user_challenge or not user_challenge.completed %}
                <form method="post" class="mt-3">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="mark_complete">
                    <button type="submit" class="btn btn-success">
                        Mark as Completed
                    </button>
                </form>
            {% else %}
                <p class="mt-3 text-success fw-semibold">
                    Completed on {{ user_challenge.completed_at|timezone:"UTC"|date:"Y-m-d H:i" }}
                </p>
            {% endif %}
        </div>
    </div>

    <!-- Custom Challenge Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h3 class="card-title mb-3">Set a Custom Challenge</h3>
            <form method="post" class="row g-3">
                {% csrf_token %}
                <input type="hidden" name="action" value="set_custom">
                <div class="col-md-9">
                    <select class="form-select" name="problem_id" required>
                        <option value="" disabled selected>Select a new challenge...</option>
                        {% for problem in problems %}
                            <option value="{{ problem.id }}">{{ problem.title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary w-100">
                        Set Challenge
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Streak Info -->
    {% if request.user.is_authenticated %}
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Your Streak</h5>
                <p class="mb-0">
                    Current Streak: <strong>{{ request.user.streak.current_streak }}</strong> days<br>
                    Longest Streak: <strong>{{ request.user.streak.longest_streak }}</strong> days
                </p>
            </div>
        </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
